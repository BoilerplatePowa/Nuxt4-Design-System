name: Deploy Storybook to GitHub Pages

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    workflow_dispatch:

env:
    NODE_VERSION: '20'

jobs:
    # Build Storybook
    build-storybook:
        name: Build Storybook
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Enable corepack
              run: npm i -g --force corepack@latest && corepack enable

            - name: Install dependencies
              run: npx nypm@latest i

            - name: Build Storybook
              run: npm run build-storybook

            - name: Upload Storybook build
              uses: actions/upload-artifact@v4
              with:
                  name: storybook-build
                  path: storybook-static/
                  retention-days: 7

    # Deploy to GitHub Pages
    deploy:
        name: Deploy to GitHub Pages
        runs-on: ubuntu-latest
        needs: build-storybook
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

        permissions:
            contents: read
            pages: write
            id-token: write

        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Enable corepack
              run: npm i -g --force corepack@latest && corepack enable

            - name: Install dependencies
              run: npx nypm@latest i

            - name: Build Storybook
              run: npm run build-storybook

            - name: Setup Pages
              uses: actions/configure-pages@v4
              with:
                enablement: true

            - name: Upload to Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: storybook-static/

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

    # Comment on PR with preview link
    pr-comment:
        name: Comment PR with Preview
        runs-on: ubuntu-latest
        needs: build-storybook
        if: github.event_name == 'pull_request'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download Storybook build
              uses: actions/download-artifact@v4
              with:
                  name: storybook-build
                  path: storybook-static/

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Upload to Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: storybook-static/

            - name: Deploy to GitHub Pages (Preview)
              uses: actions/deploy-pages@v4

            - name: Comment PR
              uses: actions/github-script@v7
              with:
                  script: |
                      const comment = `## üìö Storybook Preview

                      Your Storybook has been built and deployed for preview!

                      **üîó Preview URL**: ${{ steps.deployment.outputs.page_url }}

                      ### üìã Build Status
                      - ‚úÖ Storybook build successful
                      - ‚úÖ Deployed to GitHub Pages
                      - üîç Review your components before merging

                      ### üéØ What's Included
                      - All component stories
                      - Interactive controls
                      - Documentation
                      - Accessibility testing
                      `;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
