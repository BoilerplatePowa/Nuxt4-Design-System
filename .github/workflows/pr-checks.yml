name: Pull Request Checks

on:
    pull_request:
        types: [opened, synchronize, reopened]

env:
    NODE_VERSION: '22.18.0'

jobs:
    pr-checks:
        name: PR Quality Checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run linting
              run: npm run lint

            - name: Run type checking
              run: npm run test:types:module

            - name: Run tests
              run: npm run test

            - name: Build package
              run: npm run build

            - name: Check bundle size
              id: bundle-size
              run: |
                  npm run build
                  BUNDLE_SIZE=$(du -sb dist/ | awk '{print $1}')
                  BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
                  echo "size=$BUNDLE_SIZE_KB" >> $GITHUB_OUTPUT
                  echo "Bundle size: ${BUNDLE_SIZE_KB}KB"

            - name: Comment PR with bundle size
              uses: actions/github-script@v7
              with:
                  script: |
                      const bundleSize = '${{ steps.bundle-size.outputs.size }}';
                      const maxSize = 250; // 250KB limit
                      const warningSize = 200; // 200KB warning

                      let status = '✅';
                      let message = 'Bundle size within acceptable limits';

                      if (bundleSize > maxSize) {
                        status = '❌';
                        message = '**Warning:** Bundle size exceeds limit';
                      } else if (bundleSize > warningSize) {
                        status = '⚠️';
                        message = '**Warning:** Bundle size approaching limit';
                      }

                      const comment = `## Bundle Size Analysis

                      ${status} **Bundle Size:** ${bundleSize}KB

                      **Status:** ${message}

                      **Limits:**
                      - Maximum: ${maxSize}KB
                      - Warning: ${warningSize}KB

                      ${bundleSize > maxSize ? '### ⚠️ Action Required\n\nBundle size exceeds the maximum limit. Please optimize before merging.' : ''}
                      `;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
