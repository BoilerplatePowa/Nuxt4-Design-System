name: Pull Request Checks

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    # PR Quality Checks
    pr-checks:
        name: PR Quality Checks
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run linting
              run: npm run lint

            - name: Run type checking
              run: npm run test:types

            - name: Run tests
              run: npm run test

            - name: Check bundle size impact
              run: |
                  # Build current branch
                  npm run prepack
                  CURRENT_SIZE=$(du -s dist | cut -f1)

                  # Checkout main branch
                  git checkout main
                  npm ci
                  npm run prepack
                  MAIN_SIZE=$(du -s dist | cut -f1)

                  # Calculate impact
                  IMPACT=$((CURRENT_SIZE - MAIN_SIZE))
                  echo "Bundle size impact: ${IMPACT}KB"

                  # Comment on PR if significant increase
                  if [ $IMPACT -gt 10240 ]; then # 10KB threshold
                    echo "âš ï¸ Bundle size increased by ${IMPACT}KB"
                  fi

            - name: Comment PR
              uses: actions/github-script@v7
              if: always()
              with:
                  script: |
                      const fs = require('fs');

                      // Get bundle size impact
                      const bundleSize = process.env.BUNDLE_SIZE_IMPACT || '0';
                      const impact = parseInt(bundleSize);

                      const comment = `## ðŸ“Š Bundle Size Analysis

                      **Impact:** ${impact > 0 ? '+' : ''}${impact}KB

                      **Status:** ${impact > 10240 ? 'âš ï¸ Significant increase detected' : 'âœ… Within acceptable limits'}

                      ${impact > 10240 ? `
                      ### ðŸš¨ Bundle Size Warning
                      This PR increases the bundle size by more than 10KB. Consider:
                      - Using dynamic imports for heavy components
                      - Tree shaking unused code
                      - Optimizing dependencies
                      ` : ''}
                      `;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

    # Storybook Build Check
    storybook-check:
        name: Storybook Build Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build Storybook
              run: npm run build-storybook
              continue-on-error: true

            - name: Upload Storybook build
              uses: actions/upload-artifact@v4
              with:
                  name: storybook-build-${{ github.event.number }}
                  path: storybook-static/
                  retention-days: 7
